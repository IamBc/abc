<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Single Page App Example</title>
    <link rel="stylesheet" type="text/css" href="css/pure/pure-min.css">

    <style>
    .postBox{
        min-height:30px;
        background:gray;
        border:1px;black;
        padding:0;
        margin-top: 1px;
        margin-bottom: 1px;
        margin-right: 1px;
        margin-left: 1px;
    }
    </style>
  </head>
  <body>
    <div id="app"></div>
  </body>
  <script>
    if (! "onhashchange" in window) {
        alert("Please upgrade your browser!");
    }

    function locationHashChanged() {
        if (location.hash === "#threads") {
            getBoards();
        }
        else if (location.hash.indexOf("#thread:") > -1 ){
            getPostsForThread(location.hash.split(":")[1]);
        }
        else if (location.hash.indexOf("#board:") > -1 ){
            createBoardTemplate(location.hash.split(":")[1]);
        }
        else{
            document.getElementById("app").innerHTML = "404 page not found";
        }
    }

    window.onload = function (event) {
        window.location.hash = "#threads";
    };

    window.onhashchange = locationHashChanged;
    var threadHtml = '';

    function getBoards() {
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.open("GET", "http://127.0.0.1:8089/api?command=getBoards&api_key=d3c3f756aff00db5cb063765b828e87b");
        xmlhttp.send();

        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var resp = JSON.parse(xmlhttp.responseText);
                console.log(resp.Payload);
                
                threadHtml = '';
                document.getElementById("app").innerHTML = ''; 
                if( resp.Payload === null){
                    document.getElementById("app").innerHTML += '<p>No threads for this board</p>';
                    return;
                }
                for (var i = 0; i < resp.Payload.length; i++){
                    (function (i){
                        console.log(resp.Payload[i].Name);    
                        var xmlhttp1 = new XMLHttpRequest();
                        xmlhttp1.open("GET", "http://127.0.0.1:8089/api?command=getActiveThreadsForBoard&api_key=d3c3f756aff00db5cb063765b828e87b&board_id=" + resp.Payload[i].Id);
                        xmlhttp1.send();
                        xmlhttp1.onreadystatechange = function() {
                            if (xmlhttp1.readyState == 4 && xmlhttp1.status == 200) {
                                var respThreads = JSON.parse(xmlhttp1.responseText);
                                document.getElementById("app").innerHTML += '<a href="#board:'+resp.Payload[i].Id + '">' + resp.Payload[i].Name + '</a>';
                                console.log(resp.Payload);
                                if( respThreads.Payload === null){
                                    document.getElementById("app").innerHTML += '<p>No threads for this board</p>';
                                    return;
                                }
                                for (var k = 0; k <  respThreads.Payload.length; k++){
                                    document.getElementById("app").innerHTML += '<a href="#thread:'+respThreads.Payload[k].Id + '">' +respThreads.Payload[k].Name +' </a></br>';
                                }
                            }
                        } 
                    })(i)
                }
            }
        }
    }

    function getPostsForThread(threadId){
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", "http://127.0.0.1:8089/api?command=getPostsForThread&api_key=d3c3f756aff00db5cb063765b828e87b&thread_id=" + threadId);
        xmlhttp.send();

        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var respPosts = JSON.parse(xmlhttp.responseText);
                    console.log(respPosts.Payload);
                    var threadHtml = '<textarea rows="4" cols="50" id="newPostTextArea"></textarea><br/><input class="pure-button" type="button" onclick="submitNewPost()" value="Submit post!"  />';
                    if( respPosts.Payload !== null){ //undef means there are no posts to this thread
                        for (var k = 0; k <  respPosts.Payload.length; k++){
                            console.log (respPosts.Payload[k]);
                            threadHtml += '<p class="postBox">'+ respPosts.Payload[k].Body +'</p>';
                        }
                    }
                    document.getElementById("app").innerHTML = threadHtml; 
            }
                
        }
    }

    function submitNewPost(){
        var xmlhttp = new XMLHttpRequest();
        var threadId = location.hash.split(":")[1]; 
        xmlhttp.open("GET", "http://localhost:8089/api?command=addPostToThread&api_key=d3c3f756aff00db5cb063765b828e87b&thread_id=" + threadId + 
                            "&thread_post_body=" + escape(document.getElementById('newPostTextArea').value));
        xmlhttp.send();

        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var respPosts = JSON.parse(xmlhttp.responseText);
                    getPostsForThread(threadId)
            }
       } 
    }

    function createBoardTemplate(){
        document.getElementById("app").innerHTML = '<textarea rows="4" cols="50" id="newThreadTextArea"></textarea><br/><input class="pure-button" type="button" onclick="submitNewThread()" value="Submit Thread!"  />';
    }

    function submitNewThread(boardId){
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", "http://localhost:8089/api?command=addThread&api_key=d3c3f756aff00db5cb063765b828e87b&board_id=" +boardId +"&thread_name="+ escape(document.getElementById('newThreadTextArea').value) );
        
    }
  </script>
</html>
